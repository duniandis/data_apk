name: Sync pCloud Excel -> loglist1.csv

on:
  schedule:
    # polling tiap 10 menit (commit hanya kalau Excel berubah)
    - cron: "*/10 * * * *"
  workflow_dispatch: {}

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install rclone
        run: |
          curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Configure rclone (pCloud)
        env:
          PCLOUD_USER: ${{ secrets.PCLOUD_USER }}
          PCLOUD_PASS: ${{ secrets.PCLOUD_PASS }}
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
          [pcloud]
          type = pcloud
          username = ${PCLOUD_USER}
          password = ${PCLOUD_PASS}
          EOF

      - name: Download Excel from pCloud
        run: |
          rclone copy "pcloud:TUK (CLOUD)/2026/INPUT ANGKUT DAN STOK POSISI/INPUT ANGKUTAN_STOCK_NEW.xlsx" . --progress
          ls -lh "INPUT ANGKUTAN_STOCK_NEW.xlsx"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install openpyxl==3.1.5

      - name: Export range -> loglist1.csv
        run: |
          python tools/export_range_to_csv.py
          head -n 3 loglist1.csv || true

      - name: Commit changes if any
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add loglist1.csv .sync_state.json tools/export_range_to_csv.py
          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi
          git commit -m "Auto update loglist1.csv"
          git push
